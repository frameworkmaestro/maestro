grapher.graph = function (element, relations) {

    var $element = $('#' + element);
    var w = $element.innerWidth() - 10;
    var h = $element.innerHeight() - 10;

    var vis = this.vis = d3.select($element[0]).append("svg")
            .attr("width", w)
            .attr("height", h);

//var nodes = force.nodes(),
//    links = force.links();
    var nodes = [],
            links = [];

    var force = d3.layout.force()
            .nodes(nodes)
            .links(links)
            //.gravity(.05)
            .size([w, h])
            .linkDistance(100)
            .charge(-300)
            .start();

    // Add and remove elements on the graph object
    this.addNode = function (node) {
        nodes.push(node);
        update();
    }

    this.removeNode = function (id) {
        var i = 0;
        var n = findNode(id);
        while (i < links.length) {
            if ((links[i]['source'] === n) || (links[i]['target'] == n)) {
                links.splice(i, 1);
            } else {
                i++;
            }
        }
        var index = findNodeIndex(id);
        if (index !== undefined) {
            nodes.splice(index, 1);
            update();
        }
    }

    this.addLink = function (link) {
        var sourceNode = findNode(link.source.id);
        if (sourceNode === undefined) {
            this.addNode(link.source);
        } else {
            link.source = sourceNode;
        }
        var targetNode = findNode(link.target.id);
        if (targetNode === undefined) {
            this.addNode(link.target);
        } else {
            link.target = targetNode;
        }
        var existsLink = findLink(link);
        if (!existsLink) {
            links.push(link);
        }
        console.log(links);
        update();
    }
    
    this.refreshLink = function (types) {
        var i = 0;
        while (i < links.length) {
            if (types[links[i]['type']] === undefined) {
                links.splice(i,1);
            }
            else i++;
        }
        update();
    }
    
    this.clearLink = function () {
        var i = 0;
        while (i < links.length) {
            links.splice(i,1);
        }
        update();
    }

    this.clearNode = function () {
        var i = 0;
        while (i < nodes.length) {
            nodes.splice(i,1);
        }
        update();
    }

    var findNode = function (id) {
        for (var i = 0; i < nodes.length; i++) {
            if (nodes[i].id === id) {
                return nodes[i]
            }
        }
    }

    var findNodeIndex = function (id) {
        for (var i = 0; i < nodes.length; i++) {
            if (nodes[i].id === id) {
                return i
            }
        }
    }

    var findLink = function (link) {
        for (var i = 0; i < links.length; i++) {
            var l = links[i];
            if ((l.source.id === link.source.id) && (l.target.id === link.target.id) && (l.type === link.type)) {
                return true;
            }
        }
        return false;
    }

// Per-type markers, as they don't inherit styles.
vis.append("defs").selectAll("marker")
    .data(relations)
  .enter().append("marker")
    .attr("id", function(d) { return d; })
    .attr("viewBox", "0 -5 10 10")
    .attr("refX", 25)
    .attr("refY", -3.5)
    .attr("markerWidth", 6)
    .attr("markerHeight", 6)
    .attr("orient", "auto")
  .append("path")
    .attr("class", function(d) { return d; })
    .attr("d", "M0,-5L10,0L0,5");

        function dblclick() {
            grapher.onDblClick(d3.select(this).data()[0]);
        }


    var update = function () {
        vis.selectAll("g").remove();
        
        
        var path = vis.append("g").selectAll("path")
                .data(force.links())
                .enter().append("path")
                .attr("class", function (d) {
                    return "link " + d.type;
                })
                .attr("marker-end", function (d) {
                    return "url(#" + d.type + ")";
                });

        var circle = vis.append("g").selectAll("circle")
                .data(force.nodes())
                .enter().append("circle")
                .attr("class", function (d) {
                    return (d.idFrame == grapher.currentFrame) ? "nodeSelected" : 'nodeNormal';
                })
                .attr("r", 15)
                .on("dblclick", dblclick)
                .call(force.drag);

        var text = vis.append("g").selectAll("text")
                .data(force.nodes())
                .enter().append("text")
                .attr("x", 8)
                .attr("y", ".31em")
                .text(function (d) {
                    return d.name;
                });

        force.on("tick", function () {

            var linkArc = function (d) {
                var dx = d.target.x - d.source.x,
                        dy = d.target.y - d.source.y,
                        dr = Math.sqrt(dx * dx + dy * dy);
                return "M" + d.source.x + "," + d.source.y + "A" + dr + "," + dr + " 0 0,1 " + d.target.x + "," + d.target.y;
            }

            var transform = function (d) {
                return "translate(" + d.x + "," + d.y + ")";
            }

            path.attr("d", linkArc);
            circle.attr("transform", transform);
            text.attr("transform", transform);

        });

        // Restart the force layout.
        force.start();
    }

    // Make it all go
    update();
}


